name: Build and Release (Web/Android/iOS/macOS)

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  version:
    name: Compute Version (git describe)
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.ver.outputs.name }}
      number: ${{ steps.ver.outputs.number }}
      tag_name: ${{ steps.ver.outputs.tag_name }}
      describe: ${{ steps.ver.outputs.describe }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Compute version from git describe (and ensure base tag 0.0.1)
        id: ver
        run: |
          bash scripts/version.sh

  web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version asset
        run: bash scripts/version.sh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Generate native splash
        run: dart run flutter_native_splash:create

      - name: Build Web
        run: flutter build web --release --build-name "${{ needs.version.outputs.name }}" --build-number "${{ needs.version.outputs.number }}"

      - name: Archive Web build
        run: |
          cd build/web
          zip -r ../web-${{ needs.version.outputs.tag_name }}.zip .

      - name: Upload Artifact (web)
        uses: actions/upload-artifact@v4
        with:
          name: web-${{ needs.version.outputs.tag_name }}
          path: build/web-*.zip

  android:
    name: Build Android (APK + AAB)
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Generate version asset
        run: bash scripts/version.sh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Generate native splash
        run: dart run flutter_native_splash:create

      - name: Build APK
        run: flutter build apk --release --build-name "${{ needs.version.outputs.name }}" --build-number "${{ needs.version.outputs.number }}"

      - name: Build AppBundle (AAB)
        run: flutter build appbundle --release --build-name "${{ needs.version.outputs.name }}" --build-number "${{ needs.version.outputs.number }}"

      - name: Upload Artifact (android)
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.version.outputs.tag_name }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab

  ios:
    name: Build iOS (IPA, no codesign)
    runs-on: macos-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Generate version asset
        run: bash scripts/version.sh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Generate native splash
        run: dart run flutter_native_splash:create

      - name: Build IPA (no codesign)
        run: flutter build ipa --no-codesign --build-name "${{ needs.version.outputs.name }}" --build-number "${{ needs.version.outputs.number }}"

      - name: Upload Artifact (ios)
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.version.outputs.tag_name }}
          path: |
            build/ios/ipa/*.ipa

  macos:
    name: Build macOS (unsigned .app zip)
    runs-on: macos-latest
    needs: version
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Generate version asset
        run: bash scripts/version.sh

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Build macOS
        run: flutter build macos --release --build-name "${{ needs.version.outputs.name }}" --build-number "${{ needs.version.outputs.number }}"

      - name: Archive macOS app (.app â†’ zip)
        run: |
          set -euo pipefail
          PRODUCT_DIR="build/macos/Build/Products/Release"
          mkdir -p build
          # Create a deterministic zip including the .app bundle (keep parent so the app name is preserved)
          if compgen -G "$PRODUCT_DIR/*.app" > /dev/null; then
            ditto -c -k --sequesterRsrc --keepParent "$PRODUCT_DIR"/*.app "build/macos-${{ needs.version.outputs.tag_name }}.zip"
          else
            echo "No .app found in $PRODUCT_DIR" >&2
            ls -la "$PRODUCT_DIR" || true
            exit 1
          fi

      - name: Upload Artifact (macos)
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ needs.version.outputs.tag_name }}
          path: build/macos-*.zip

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [version, web, android, ios, macos]
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag_name }}
          name: ${{ needs.version.outputs.tag_name }}
          body: |
            Automated release built from commit ${{ github.sha }}

            Version (git describe): `${{ needs.version.outputs.describe }}`

            Artifacts:
            - Web ZIP
            - Android APK & AAB
            - iOS IPA (unsigned)
            - macOS app (.app zipped, unsigned)
          files: |
            dist/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
